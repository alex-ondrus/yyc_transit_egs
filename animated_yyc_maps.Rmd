---
title: "Mapping VPL Data"
author: "Alexander Ondrus"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Goals

Using pre-processed data containing time stamped _Vehicle Position Logs_ (VPLs), I want to create animated maps that show the following:

1. The position of each bus in the city on 5 minute intervals
2. The average prediction for derivation from the schedule (early or late) for all busses in each community, by hour
3. The average speed for all busses passing through each neighbourhood, by hour

## Loading Libraries and Data

First, I load in the vehicle position logs along with libraries for aggregating and manipulating data, working with dates, and working with geospatial information. I also load in a shapefile of Calgary community boundaries from the City of Calgary Open Data Catalogue [here](https://data.calgary.ca/Base-Maps/Community-Boundaries/ab7m-fwn6).

```{r loading libraries and data}
library(tidyverse)
library(lubridate)
library(rgdal)
library(rgeos)
library(maptools)
library(gifski)
library(gganimate)

vpl_15052019 <- readRDS("vpl_15052019.rds")
community_boundaries <- readOGR("geo_export_e135fc9f-0eec-429a-b94b-14836af732d4.shp")
community_bounds_df <- fortify(community_boundaries,
                               region = "name")
```

## First Map: Vehicle Locations

For this map, I need to have a data frame with the time stamps synchronized so that I can plot them on the same frame. I do this by rounding each time stamp to the nearest 5 minutes, and then aggregating the vehicle positions by taking the mean of the vehicle positions over that 5 minute interval.

```{r synchronizing time stamps}
vpl_5_min_intervals <- vpl_15052019
vpl_5_min_intervals$vehicle_position_date_time <-
  round_date(vpl_5_min_intervals$vehicle_position_date_time,
             unit = "5 minutes")
vpl_5_min_intervals <- group_by(vpl_5_min_intervals,
                                vehicle_position_date_time,
                                vehicle_id) %>% 
  summarise(longitude = mean(longitude),
            latitude = mean(latitude)) %>% 
  arrange(vehicle_position_date_time, vehicle_id)
```

```{r generate animated vehicle location map}
p <- ggplot(vpl_5_min_intervals,
            aes(x = longitude,
                y = latitude)) +
  geom_point(aes(group = vehicle_id),
             colour = "red") +
  labs(title = "Position of YYC Transit Vehicles",
       subtitle = "at time {closest_state}",
       caption = "Data: City of Calgary Open Data\nCreated by Alexander Ondrus") +
  geom_polygon(data = community_bounds_df,
               aes(x = long,
                   y = lat,
                   group = group),
               fill = NA,
               colour = "grey") +
  theme_void() +
  coord_equal() +
  transition_states(vehicle_position_date_time,
                    transition_length = 4,
                    state_length = 1)
  
#animate(p, nframes = 1440, duration = 60)
```

